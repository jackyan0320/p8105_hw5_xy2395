---
title: "P8105_hw5_xy2395"
author: "Jack Yan"
date: "11/2/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

# Problem 1

## Data manipulation

```{r, message = FALSE}
data_p1 = 
  list.files("./data/problem_1") %>% 
  as.tibble() %>% 
  mutate(value = str_c("./data/problem_1/", value),
         new_id = 1:20
         )

data_p1 = 
  map(.x = data_p1$value, ~read_csv(.x)) %>%
  mutate(data_p1, data = .) %>% 
  unnest %>% 
  mutate(value = str_replace(value, "./data/problem_1/", "")) %>% 
  mutate(value = str_replace(value, ".csv", "")) %>% 
  separate(value, into = c("arm", "id"), sep = "_") %>% 
  gather(key = week, value = value, week_1:week_8) %>% 
  mutate(week = str_replace(week, "week_", ""),
         arm = as.factor(arm),
         week = as.factor(week),
         id = as.numeric(id) %>% as.factor()
  )

head(data_p1)
```

## Plot

```{r}
# plot observations on each subject over time
data_p1 %>% 
  group_by(arm, new_id) %>% 
  ggplot(aes(x = week, y = value, group = new_id, color = arm)) +
  geom_line() +
  labs(
    title = "Observations on each subject over time"
  )
```

Comment:
Observations for the experimental group tended to increase over time, whereas observations for the control group did not show trend of increase over time.

# Problem 2

Describe the raw data.

Create a city_state variable (e.g. “Baltimore, MD”) and then summarize within cities to obtain the total number of homicides and the number of unsolved homicides (those for which the disposition is “Closed without arrest” or “Open/No arrest”).

```{r, message = FALSE}
data_p2 = 
  read_csv("./data/homicide-data.csv") %>% 
  mutate(city_state = str_c(city, ", ", state),
         disposition = as.factor(disposition))

n_total = 
  data_p2 %>% 
  group_by(city_state) %>% 
  count() %>% 
  rename(n_total = n) 

n_unsolved = 
  data_p2 %>% 
  group_by(city_state) %>% 
  filter(disposition != "Closed by arrest") %>% 
  count() %>% 
  rename(n_unsolved = n) 

full_join(n_total, n_unsolved) %>% filter(is.na(n_unsolved) == T)

count_data = 
  inner_join(n_total, n_unsolved) %>% 
  ungroup()
```

For the city of Baltimore, MD:
```{r}
sample = 
  count_data %>% 
  filter(city_state == "Baltimore, MD")

prop.test(sample$n_unsolved, sample$n_total) %>% 
  broom::tidy() %>% 
  select(estimate, conf.low, conf.high)
```

Function:

```{r}
custom_prop_test = function(x_city){
  
  sample = 
    count_data %>% 
    filter(city_state == x_city)

  prop.test(sample$n_unsolved, sample$n_total) %>% 
  broom::tidy() %>% 
  select(estimate, conf.low, conf.high)
}
```

Iteration:

```{r }
prop_data = 
  map(.x = count_data$city_state, ~custom_prop_test(.x)) %>% 
  mutate(count_data, result = .) %>% 
  unnest %>% 
  select(city_state, estimate, conf.low, conf.high)

prop_data
```

Plot:

Create a plot that shows the estimates and CIs for each city – check out geom_errorbar for a way to add error bars based on the upper and lower limits. Organize cities according to the proportion of unsolved homicides.

```{r}
prop_data %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate, ymin = conf.low, ymax = conf.high)) +
  geom_point() +
  geom_errorbar() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = rel(0.8))) +
  labs(
    x = "City",
    y = "Proportion",
    title = "Proportion of unsolved cases: Estimates and CIs for each city"
  )

```

